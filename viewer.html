<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bobinas ‚Ä¢ Viewer</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #0b0e14;
      --card: #111520;
      --muted: #97a3b6;
      --text: #e6edf6;
      --accent: #4f46e5;
      --accent-2: #22c55e;
      --border: #1c2233;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f8fb;
        --card: #ffffff;
        --muted: #64748b;
        --text: #0f172a;
        --accent: #4f46e5;
        --accent-2: #16a34a;
        --border: #e5e7eb;
        --danger: #dc2626;
        --shadow: 0 10px 30px rgba(2,6,23,.08);
      }
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; padding:24px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(79,70,229,.20), transparent 40%),
        radial-gradient(1000px 700px at 110% 10%, rgba(34,197,94,.12), transparent 45%),
        var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 960px; margin:0 auto; display:grid; gap:16px }
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding:16px 20px; border:1px solid var(--border); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--card);
      box-shadow: var(--shadow);
      flex-wrap: wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:700; letter-spacing:.2px;
      min-width: 220px;
    }
    .brand .dot{ width:10px; height:10px; border-radius:999px; background:var(--accent) }

    /* buscador ID en header */
    .id-tools{
      display:flex; gap:8px; align-items:center;
      flex-wrap: wrap;
      min-width: 280px;
      flex: 1 1 420px;
      justify-content: flex-end;
    }
    .id-tools .row{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
      width: 100%;
    }
    .id-input{
      flex: 1 1 220px;
      min-width: 180px;
      max-width: 360px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      outline:none;
    }
    .id-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; background: rgba(79,70,229,.15); color: var(--text);
      border:1px solid rgba(79,70,229,.35); font-weight:600; font-size:13px;
      white-space: nowrap;
    }
    .btn{
      appearance:none; border:1px solid transparent; border-radius:10px;
      padding:10px 14px; font-weight:700; cursor:pointer;
      background:var(--accent); color:white; box-shadow: 0 6px 20px rgba(79,70,229,.35);
      transition: transform .04s ease, filter .15s ease, box-shadow .15s ease;
      white-space: nowrap;
    }
    .btn:hover{ filter:brightness(1.05); box-shadow:0 10px 26px rgba(79,70,229,.45) }
    .btn:active{ transform: translateY(1px) }
    .btn-ghost{
      background:transparent; border:1px solid var(--border); color:var(--text);
      box-shadow:none;
    }

    .grid{
      display:grid; grid-template-columns: 1.1fr .9fr; gap:16px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr }
    }
    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      padding:18px;
      box-shadow: var(--shadow);
    }
    .title{
      margin:0 0 10px; font-size:22px; font-weight:800; letter-spacing:.2px;
    }
    .rows{ display:grid; gap:10px }
    .row{ display:flex; align-items:baseline; gap:10px; line-height:1.35; flex-wrap:wrap }
    .row b{
      min-width: 190px; font-weight:700; color: var(--muted);
    }
    .muted{ color: var(--muted) }
    .error{ color: var(--danger) }
    a{ color:var(--accent); text-decoration: none }
    a:hover{ text-decoration: underline }
    .hero-img{
      width:100%; max-height:360px; object-fit:contain;
      border-radius:12px; border:1px solid var(--border); background: #0b0f19;
    }

    .form-grid{ display:grid; gap:12px }
    .input{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:transparent; color:var(--text);
      outline:none;
    }
    .input::placeholder{ color: color-mix(in oklab, var(--muted) 80%, transparent) }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end }
    .status{ font-size:14px }
    .spacer{ height:4px }
    .skeleton{ height:14px; background: linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.02), rgba(255,255,255,.08)); border-radius:8px; animation: pulse 1.2s infinite }
    @keyframes pulse{ 0%{ background-position:-200px 0 } 100%{ background-position:200px 0 } }

    /* Contorno rojo alerta */
    .alerta-roja{
      outline: 3px solid var(--danger);
      box-shadow: 0 0 0 8px rgba(239,68,68,.24);
    }

    /* Modal esc√°ner */
    .modal-backdrop{
      position: fixed; inset:0; background: rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index: 50;
    }
    .modal{
      width:min(680px, 94vw);
      border-radius:16px; border:1px solid var(--border);
      background: var(--card); padding:16px;
      box-shadow: var(--shadow);
    }
    .modal header{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; border:none; border-radius:0; background:transparent; box-shadow:none; padding: 0 0 10px;
    }
    .video-wrap{
      position: relative; border:1px solid var(--border); border-radius:12px; overflow:hidden;
      background:#000;
      aspect-ratio: 4 / 3;
    }
    video{ width:100%; height:auto; display:block; }
    .scan-hint{ margin-top:8px; font-size:14px; color:var(--muted) }
    .modal footer{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    .scan-guide{ position:absolute; left:0; right:0; top:50%; transform:translateY(-50%);
      height: 33%; outline: 2px dashed rgba(255,255,255,.5); pointer-events:none; }

    /* Ajuste: video y foto ocupan exactamente el mismo lienzo (solo en modal 1D) */
    #scan1DModal .video-wrap video,
    #scan1DModal .video-wrap img#scan1DStill{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none; /* se muestran/ocultan por JS */
    }
  </style>
  <!-- Fallback QR decoder (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" defer></script>
  
  <!-- Quagga2 (Code 128 imagen √∫nica) -->
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js" defer></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="dot"></div>
        <div>Bobinas ‚Ä¢ Viewer</div>
      </div>

      <!-- buscador / pegar / escanear -->
      <div class="id-tools">
        <div class="row">
          <span id="badge" class="id-badge">ID: ‚Äî</span>
          <input id="idInput" class="id-input" placeholder="Escrib√≠ o peg√° un ID o URL‚Ä¶" inputmode="text" />
          <button id="goBtn" class="btn">Buscar</button>
          <button id="pasteBtn" class="btn btn-ghost" title="Pegar desde portapapeles">Pegar</button>
          <button id="scanQrBtn" class="btn btn-ghost" title="Escanear QR">Escanear QR</button>
          <button id="scan1DBtn" class="btn btn-ghost" title="Escanear Code 128">Escanear Code 128</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- Ficha -->
      <section class="card" id="card" style="display:none">
        <h2 class="title">Ficha de bobina</h2>
        <div class="rows" id="rows"></div>
        <div class="spacer"></div>
        <div id="extra-links"></div>
      </section>

      <!-- Imagen + Acciones -->
      <aside class="card" id="media">
        <h2 class="title">Imagen</h2>
        <div id="imgWrap" class="muted">Cargando imagen‚Ä¶</div>
      </aside>
    </div>

    <!-- Devoluci√≥n -->
    <section class="card" id="devolucion" style="display:none">
      <div class="toolbar" style="justify-content:space-between">
        <h2 class="title" style="margin:0">Cargar devoluci√≥n</h2>
        <small class="muted">Actualiza stock y deja traza en T_DEVOLUCIONES</small>
      </div>
      <form id="devForm" class="form-grid">
        <div class="row">
          <b>CANTIDAD DEVUELTA</b>
          <input class="input" type="number" min="0" step="1" name="cantidad_devolucion" required placeholder="0">
        </div>
        <div class="row">
          <b>L√çNEA</b>
          <input class="input" type="text" name="linea" placeholder="Ej. L3">
        </div>
        <div class="row">
          <b>OBSERVACI√ìN</b>
          <input class="input" type="text" name="observacion" placeholder="Motivo / nota">
        </div>
        <div class="row">
          <b>USUARIO</b>
          <input class="input" type="text" name="usuario" placeholder="(opcional)">
        </div>
        <div class="toolbar">
          <button type="submit" class="btn">Enviar devoluci√≥n</button>
          <span id="devStatus" class="status muted"></span>
        </div>
      </form>
    </section>

    <div id="status" class="muted">Cargando‚Ä¶</div>
  </div>

  <!-- Modal esc√°ner -->
  <div id="scanModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="scanTitle">
      <header>
        <h3 id="scanTitle" class="title" style="margin:0">Escanear c√≥digo</h3>
        <button id="closeScanBtn" class="btn btn-ghost">Cerrar</button>
      </header>
      <div class="video-wrap">
        <video id="scanVideo" autoplay playsinline></video>
        <!-- canvas oculto para fallback jsQR -->
        <canvas id="scanCanvas" style="display:none"></canvas>
      </div>
      <div id="scanHint" class="scan-hint">Apunt√° a un QR (URL) o a un Code128 (ID). Se detecta autom√°ticamente.</div>
      <footer>
        <button id="scanStopBtn" class="btn btn-ghost">Detener</button>
      </footer>
    </div>
  </div>

  <!-- Modal esc√°ner 1D (foto) -->
  <div id="scan1DModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="scan1DTitle">
      <header>
        <h3 id="scan1DTitle" class="title" style="margin:0">Escanear Code 128</h3>
        <button id="closeScan1DBtn" class="btn btn-ghost">Cerrar</button>
      </header>
      <div class="video-wrap">
        <video id="scan1DVideo" autoplay playsinline></video>
        <div class="scan-guide" aria-hidden="true"></div>
        <canvas id="scan1DCanvas" style="display:none"></canvas>
        <canvas id="scan1DCrop" style="display:none"></canvas>
        <img id="scan1DStill" style="display:none; width:100%; height:auto;" alt="Captura"/>
      </div>
      <div id="scan1DHint" class="scan-hint">Aline√° el c√≥digo dentro de la franja marcada y toc√° ‚ÄúTomar foto‚Äù.</div>
      <footer>
        <button id="takePhoto1DBtn" class="btn" disabled>Tomar foto</button>
        <button id="retry1DBtn" class="btn btn-ghost" style="display:none">Reintentar</button>
      </footer>
    </div>
  </div>

  <script>
    // ===== Endpoints Netlify =====
    const FLOW_GET_BOBINA_URL = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ddf0b0a84bda4428b59d464812b6b734/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=SylYZCLZTHEF4kj1OD9YCpCGAfUuA2T5R8dS5rvD25s";

    // ‚Äî‚Äî‚Äî Helpers ‚Äî‚Äî‚Äî
    function getId() {
      const params = new URLSearchParams(window.location.search);
      const q = params.get('id');
      if (q) return q;
      const parts = window.location.pathname.split('/').filter(Boolean);
      return parts[parts.length - 1] || null;
    }
    function gotoId(id){
      if(!id){ toast('Ingres√° un ID v√°lido', true); return; }
      const base = location.pathname.split('/').pop() || 'viewer.html';
      const path = base.includes('.html') ? base : 'viewer.html';
      location.href = `${path}?id=${encodeURIComponent(id)}`;
    }
    // extrae ID desde texto/URL
    function extractIdFromAny(str){
      if(!str) return '';
      const s = String(str).trim();
      try{
        const u = new URL(s);
        const q = u.searchParams.get('id');
        if(q) return q.trim();
      }catch{}
      const m = s.toUpperCase().match(/\bCQ[0-9A-Z\-_.]+\b/);
      if(m && m[0]) return m[0];
      if (/^[0-9A-Za-z\-_]+$/.test(s)) return s;
      return '';
    }

    function normalizeSharePointImageUrl(u) {
      if (!u) return u;
      u = u.replace(/%2520/g, '%20');
      try {
        const url = new URL(u);
        if (url.pathname.startsWith('/:u:/') || url.pathname.startsWith('/:i:/') || url.pathname.startsWith('/:x:/')) {
          if (!url.searchParams.has('download')) url.searchParams.set('download','1');
          return url.toString();
        }
        if (url.pathname.includes('/Forms/AllItems.aspx')) {
          const idParam = url.searchParams.get('id');
          if (idParam) {
            const decoded = decodeURIComponent(idParam);
            const base = url.origin + '/sites/ALMACENPRE-PRODUCCION/_layouts/15/download.aspx?SourceUrl=';
            return base + encodeURIComponent(decoded);
          }
        }
        return u;
      } catch { return u; }
    }

    function fieldRow(label, value) {
      return `<div class="row"><b>${label}:</b> ${value ?? ''}</div>`;
    }

    // ===== Fechas/alerta =====
    const stripDiacritics = (s)=> (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const normText = (s)=> stripDiacritics(String(s||'')).replace(/\s+/g,' ').trim().toUpperCase();

    function parseDateFlexible(v){
      if (v == null || v === '') return null;
      const s = String(v).trim();
      if (/^\d+(\.\d+)?$/.test(s)) { // Excel serial
        const t = Math.round((Number(s) - 25569) * 86400 * 1000);
        const d = new Date(t);
        return isNaN(d) ? null : d;
      }
      const d = new Date(s);
      return isNaN(d) ? null : d;
    }
    function formatDMY(v){
      const d = parseDateFlexible(v);
      if (!d) return v || '‚Äî';
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function yearsDiff(a,b){ return (b - a) / (365.25 * 24 * 3600 * 1000); }
    function applyAlert(fechaIngresoRaw, estadoRaw){
      const cardEl = document.getElementById('card');
      if (!cardEl) return;
      let danger = false;
      const d = parseDateFlexible(fechaIngresoRaw);
      if (d && yearsDiff(d, new Date()) >= 2) danger = true;
      const estN = normText(estadoRaw);
      if (estN.startsWith('BLOQUE')) danger = true;
      cardEl.classList.toggle('alerta-roja', danger);
    }

    // ===== UI helpers =====
    function toast(msg, isErr=false){
      const el = document.getElementById('status');
      el.innerHTML = isErr ? `<span class="error">${msg}</span>` : msg;
    }

    // ‚Äî‚Äî‚Äî Editable rows ‚Äî‚Äî‚Äî
    function editableRow({ label, value, field, type = 'text', options = [], onSave }) {
      const row = document.createElement('div');
      row.className = 'row';

      const bold = document.createElement('b'); bold.textContent = label + ':';
      const span = document.createElement('span'); span.id = `val-${field}`; span.textContent = value ?? '';

      const btn = document.createElement('button');
      btn.type = 'button'; btn.className = 'btn btn-ghost'; btn.textContent = 'Editar';

      const inputWrap = document.createElement('span'); inputWrap.style.display = 'none';
      let input;
      if (type === 'select') {
        input = document.createElement('select'); input.className = 'input';
        const optEmpty = document.createElement('option'); optEmpty.value = ''; optEmpty.textContent = '(seleccionar)'; input.appendChild(optEmpty);
        (options || []).forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; input.appendChild(opt); });
        const current = (value ?? '').toString().trim();
        const has = Array.from(input.options).some(o => o.value === current);
        if (current && !has) input.add(new Option(current, current));
        input.value = current || '';
      } else {
        input = document.createElement('input'); input.className = 'input'; input.type = (type === 'number') ? 'number' : 'text';
        if (type === 'number') { input.min = '0'; input.step = '1'; }
        input.value = value ?? '';
      }

      const save = document.createElement('button'); save.type = 'button'; save.className = 'btn'; save.textContent = 'Guardar';
      const cancel = document.createElement('button'); cancel.type = 'button'; cancel.className = 'btn btn-ghost'; cancel.textContent = 'Cancelar';
      const status = document.createElement('span'); status.className = 'status muted'; status.style.marginLeft = '8px';

      inputWrap.appendChild(input);
      inputWrap.appendChild(save);
      inputWrap.appendChild(cancel);
      inputWrap.appendChild(status);

      row.appendChild(bold);
      row.appendChild(span);
      row.appendChild(btn);
      row.appendChild(inputWrap);

      function enterEdit() {
        btn.style.display = 'none';
        span.style.display = 'none';
        inputWrap.style.display = 'inline-flex';
        input.focus();
        if (type !== 'select') input.select();
      }
      function exitEdit() {
        btn.style.display = 'inline-block';
        span.style.display = 'inline';
        inputWrap.style.display = 'none';
        status.textContent = '';
      }

      btn.addEventListener('click', enterEdit);
      cancel.addEventListener('click', exitEdit);

      save.addEventListener('click', async () => {
        const newValRaw = (type === 'number') ? Number(input.value) : input.value.trim();
        status.textContent = 'Guardando‚Ä¶';
        try {
          await onSave(newValRaw, status, (finalVal) => {
            span.textContent = (finalVal ?? newValRaw) || '';
            exitEdit();
          });
        } catch (e) {
          status.innerHTML = `<span class="error">${e?.message || 'Error'}</span>`;
        }
      });

      return row;
    }

    // ‚Äî‚Äî‚Äî App ‚Äî‚Äî‚Äî
    async function main() {
      const id = getId();
      const statusEl = document.getElementById('status');
      const cardEl = document.getElementById('card');
      const rowsEl = document.getElementById('rows');
      const badge = document.getElementById('badge');
      const extraLinks = document.getElementById('extra-links');
      const imgWrap = document.getElementById('imgWrap');

      const idInput = document.getElementById('idInput');
      if (id) {
        badge.textContent = `ID: ${id}`;
        idInput.value = id;
      } else {
        badge.textContent = 'ID: ‚Äî';
      }

      if (!id) { statusEl.innerHTML = '<span class="error">Falta par√°metro "id"</span>'; return; }

      try {
        statusEl.textContent = 'Consultando‚Ä¶';

        const r = await fetch(`${FLOW_GET_BOBINA_URL}&id=${encodeURIComponent(id)}&t=${Date.now()}`, {
          cache: 'no-store',
          headers: { 'Accept': 'application/json' }
        });

        const txt = await r.text();
        let data; try { data = JSON.parse(txt); } catch { data = { error:'parse_error', raw:txt }; }

        if (!r.ok || data.error) {
          statusEl.innerHTML = `<span class="error">Error: ${data.message || data.error || r.status}</span>`;
          return;
        }

        const get = (k, alts=[]) => {
          if (data[k] != null && data[k] !== '') return data[k];
          for (const a of alts) if (data[a] != null && data[a] !== '') return data[a];
          return '';
        };

        // Valores crudos (para l√≥gica) + fechas formateadas
        const fechaIngresoRaw    = get('FECHA_INGRESO', ['FECHA INGRESO']);
        const fechaDevolucionRaw = get('FECHA_DEVOLUCION', ['FECHA DEVOLUCI√ìN']);
        const estadoRaw          = get('ESTADO');

        const itemsStatic = [
          ['ID_FILA', get('ID_FILA') || get('ID')],
          ['C√ìDIGO', get('CODIGO', ['C√ìDIGO'])],
          ['DESCRIPCI√ìN', get('DESCRIPCION', ['DESCRIPCI√ìN'])],
          ['PROVEEDOR', get('PROVEEDOR')],
          ['FECHA INGRESO', formatDMY(fechaIngresoRaw) || '‚Äî'],
          ['LOTE', get('LOTE')],
          ['FECHA DEVOLUCI√ìN', formatDMY(fechaDevolucionRaw) || '‚Äî'],
          ['L√çNEA', get('ULTIMA_LINEA', ['LINEA'])],
          ['OBSERVACI√ìN', get('OBSERVACION', ['OBSERVACI√ìN'])]
        ];

        rowsEl.innerHTML = itemsStatic.map(([k,v]) => `<div class="row"><b>${k}:</b> ${v || ''}</div>`).join('');

        // ===== Editables =====
        const guardarCambio = async (payload, status, afterOk) => {
          const r = await fetch('/api/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const txt = await r.text();
          let out; try { out = JSON.parse(txt); } catch { out = { raw: txt }; }
          if (!r.ok || out.error) throw new Error(out.message || out.error || r.status);
          status.textContent = 'OK';
          await refetchAndPatch();
          afterOk();
        };

        async function refetchAndPatch() {
          const r2 = await fetch(`${FLOW_GET_BOBINA_URL}&id=${encodeURIComponent(id)}&v=${Date.now()}`, {
            cache: 'no-store',
            headers: { 'Accept': 'application/json' }
          });
          const t2 = await r2.text();
          let d2; try { d2 = JSON.parse(t2); } catch { d2 = null; }
          if (r2.ok && d2 && !d2.error) {
            document.getElementById('val-cantidad') && (document.getElementById('val-cantidad').textContent = d2.CANTIDAD ?? '');
            document.getElementById('val-ubicacion_almacen') && (document.getElementById('val-ubicacion_almacen').textContent =
              d2.UBICACION_ALMACEN || d2['UBICACION ALMACEN'] || d2['UBICI√ìN'] || d2['UBICACI√ìN'] || '');
            document.getElementById('val-estado') && (document.getElementById('val-estado').textContent = d2.ESTADO ?? '');
            applyAlert(d2.FECHA_INGRESO ?? d2['FECHA INGRESO'], d2.ESTADO);
          }
        }

        rowsEl.appendChild(editableRow({
          label: 'CANTIDAD',
          value: get('CANTIDAD'),
          field: 'cantidad',
          type: 'number',
          onSave: async (newVal, status, done) => {
            if (isNaN(newVal) || newVal < 0) throw new Error('Cantidad inv√°lida');
            await guardarCambio({ id, cantidad: Number(newVal) }, status, () => done());
          }
        }));

        rowsEl.appendChild(editableRow({
          label: 'UBICACI√ìN',
          value: get('UBICACION_ALMACEN', ['UBICACI√ìN']),
          field: 'ubicacion_almacen',
          type: 'text',
          onSave: async (newVal, status, done) => {
            if (!newVal) throw new Error('Ubicaci√≥n vac√≠a');
            await guardarCambio({ id, ubicacion_almacen: newVal }, status, () => done());
          }
        }));

        rowsEl.appendChild(editableRow({
          label: 'ESTADO',
          value: estadoRaw,
          field: 'estado',
          type: 'select',
          options: ['ALMACEN', 'LINEA', 'BLOQUEADA'],
          onSave: async (newVal, status, done) => {
            if (!newVal) throw new Error('Seleccion√° un estado');
            await guardarCambio({ id, estado: newVal }, status, () => {
              applyAlert(fechaIngresoRaw, newVal);
              done();
            });
          }
        }));

        // Link ficha/imagen
        const url = get('URL');
        if (url) {
          extraLinks.innerHTML = fieldRow('Ficha/Imagen', `<a href="${url}" target="_blank" rel="noreferrer">Abrir</a>`);
        }

        // Mostrar tarjeta, esconder status
        cardEl.style.display = 'block';
        statusEl.style.display = 'none';

        // Imagen
        const raw = get('IMAGEN_URL', ['IMAGEN URL']);
        if (raw) {
          const imgUrl = normalizeSharePointImageUrl(raw);
          imgWrap.innerHTML = `
            <img src="${imgUrl}" alt="Etiqueta" class="hero-img" loading="lazy" referrerpolicy="no-referrer"/>
            <div style="margin-top:6px"><a href="${imgUrl}" target="_blank" rel="noreferrer">Abrir en pesta√±a nueva</a></div>
          `;
        } else {
          imgWrap.innerHTML = '<span class="muted">Sin imagen configurada.</span>';
        }

        // ‚Äî Devoluci√≥n ‚Äî
        const dev = document.getElementById('devolucion');
        const devForm = document.getElementById('devForm');
        const devStatus = document.getElementById('devStatus');
        dev.style.display = 'block';

        devForm.addEventListener('submit', async (ev) => {
          ev.preventDefault();
          devStatus.textContent = 'Enviando‚Ä¶';
          const payload = {
            id,
            cantidad_devolucion: Number(devForm.cantidad_devolucion.value),
            linea: devForm.linea.value || undefined,
            observacion: devForm.observacion.value || undefined,
            usuario: devForm.usuario.value || undefined
          };
          Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);

          try {
            const rr = await fetch('/api/devolucion', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const t2 = await rr.text();
            let out; try { out = JSON.parse(t2); } catch { out = { raw: t2 }; }
            if (!rr.ok || out.error) {
              devStatus.innerHTML = `<span class="error">Error: ${out.message || out.error || rr.status}</span>`;
              return;
            }
            devStatus.textContent = 'OK. Devoluci√≥n cargada.';
            setTimeout(() => window.location.reload(), 800);
          } catch (e) {
            devStatus.innerHTML = `<span class="error">${e?.message || 'Error inesperado'}</span>`;
          }
        });

        // Alerta visual inicial
        applyAlert(fechaIngresoRaw, estadoRaw);

      } catch (e) {
        const statusEl = document.getElementById('status');
        statusEl.innerHTML = `<span class="error">${e?.message || 'Error inesperado'}</span>`;
      }
    }

    // ====== Header: buscar / pegar / escanear ======
    document.addEventListener('DOMContentLoaded', function(){
    (function initHeaderSearch(){
      const idInput = document.getElementById('idInput');
      const goBtn   = document.getElementById('goBtn');
      const pasteBtn= document.getElementById('pasteBtn');
      const scanQrBtn = document.getElementById('scanQrBtn');
      const scan1DBtn = document.getElementById('scan1DBtn');

      idInput.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          const id = extractIdFromAny(idInput.value);
          gotoId(id);
        }
      });
      goBtn.addEventListener('click', ()=>{
        const id = extractIdFromAny(idInput.value);
        gotoId(id);
      });
      pasteBtn.addEventListener('click', async ()=>{
        try{
          const txt = await navigator.clipboard.readText();
          if(!txt){ toast('Portapapeles vac√≠o', true); return; }
          const id = extractIdFromAny(txt);
          if(!id){ toast('No se encontr√≥ un ID en el texto pegado', true); return; }
          idInput.value = id;
          gotoId(id);
        }catch(err){
          toast('No se pudo leer el portapapeles', true);
        }
      });

      if (scanQrBtn) scanQrBtn.addEventListener('click', openScanModal);
      if (scan1DBtn) scan1DBtn.addEventListener('click', openScan1DModal);
    })();
  }, { once: true });

    // ====== Esc√°ner (BarcodeDetector + fallback jsQR) ======
    // (QR) ‚Äî existe c√≥digo debajo que NO tocamos
    // (1D Code128 por foto) ‚Äî variables separadas
let scan1DStream = null;
let decoding1D = false;

// Abre modal 1D, inicia c√°mara solo para preview (no decodifica en vivo)
async function openScan1DModal(){
  const modal = document.getElementById('scan1DModal');
  const video = document.getElementById('scan1DVideo');
  const hint  = document.getElementById('scan1DHint');
  const still = document.getElementById('scan1DStill');

  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');

  // Estado UI
  hint.textContent = 'Aline√° el c√≥digo dentro de la franja marcada y toc√° ‚ÄúTomar foto‚Äù.';
  still.style.display = 'none';
  video.style.display = '';
  const guide = document.querySelector('#scan1DModal .scan-guide');
  if (guide) guide.style.display = '';

  try{
    scan1DStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, aspectRatio: { ideal: 4/3 } }, audio: false });
    video.srcObject = scan1DStream;
    try { await video.play(); }catch(e){}
    await new Promise(r => { if (video.readyState >= 1) r(); else video.onloadedmetadata = r; });

    // Esperar a que el <video> tenga dimensiones v√°lidas
    const t0 = Date.now();
    while (!(video.videoWidth > 0 && video.videoHeight > 0) && Date.now() - t0 < 1500) {
      await new Promise(res => setTimeout(res, 50));
    }
    document.getElementById('takePhoto1DBtn').disabled = !(video.videoWidth > 0 && video.videoHeight > 0);

  }catch(e){
    hint.innerHTML = 'No se pudo acceder a la c√°mara. Verific√° permisos o peg√° el ID manualmente.';
  }

  // acciones
  document.getElementById('takePhoto1DBtn').onclick = takePhoto1D;
  document.getElementById('retry1DBtn').onclick = reset1DView;
  document.getElementById('closeScan1DBtn').onclick = closeScan1DModal;
  modal.addEventListener('click', (ev)=>{ if(ev.target===modal) closeScan1DModal(); });
}

function reset1DView(){
  const hint  = document.getElementById('scan1DHint');
  const still = document.getElementById('scan1DStill');
  const video = document.getElementById('scan1DVideo');
  const guide = document.querySelector('#scan1DModal .scan-guide');

  hint.textContent = 'Aline√° el c√≥digo dentro de la franja marcada y toc√° ‚ÄúTomar foto‚Äù.';
  still.style.display = 'none';
  video.style.display = '';
  if (guide) guide.style.display = '';

  document.getElementById('retry1DBtn').style.display = 'none';
  document.getElementById('takePhoto1DBtn').disabled = false;
}

// Saca foto, cierra c√°mara y decodifica la imagen (full ‚Üí bandas ‚Üí rotaci√≥n)
async function takePhoto1D(){
  if(decoding1D) return;
  decoding1D = true;
  const video = document.getElementById('scan1DVideo');
  const full  = document.getElementById('scan1DCanvas');
  const crop  = document.getElementById('scan1DCrop');
  const still = document.getElementById('scan1DStill');
  const hint  = document.getElementById('scan1DHint');
  const retry = document.getElementById('retry1DBtn');

  try{
    // Dimensiones del video
    const vw = video.videoWidth, vh = video.videoHeight;
    if(!vw || !vh){ hint.textContent = 'No hay imagen de c√°mara disponible.'; decoding1D = false; return; }

    // Limitar resoluci√≥n para performance
    const MAX_SIDE = 1280;
    let tw = vw, th = vh;
    if (Math.max(vw, vh) > MAX_SIDE) {
      const scale = MAX_SIDE / Math.max(vw, vh);
      tw = Math.round(vw*scale);
      th = Math.round(vh*scale);
    }

    // Dibujar frame completo
    full.width = tw; full.height = th;
    const fctx = full.getContext('2d', { willReadFrequently: true });
    fctx.drawImage(video, 0, 0, tw, th);

    // Apagar c√°mara ya (evita conflictos en iOS)
    try{ video.pause(); }catch{}
    if(video.srcObject){
      try{ video.srcObject.getTracks().forEach(t=>t.stop()); }catch{}
      video.srcObject = null;
    }
    if(scan1DStream){
      try{ scan1DStream.getTracks().forEach(t=>t.stop()); }catch{}
      scan1DStream = null;
    }

    // Mostrar foto al usuario (ocultar video y gu√≠a para evitar superposici√≥n)
    still.src = full.toDataURL('image/jpeg', 0.92);
    const guide2 = document.querySelector('#scan1DModal .scan-guide');
    if (guide2) guide2.style.display = 'none';
    video.style.display = 'none';
    still.style.display = 'block';

    // Recortes (33% de alto)
    const bandH = Math.round(th * 0.33);
    const sx = 0, sw = tw;
    const syC = Math.round((th - bandH)/2);
    const syT = 0;
    const syB = th - bandH;

    crop.width = sw; crop.height = bandH;
    const cctx = crop.getContext('2d', { willReadFrequently: true });
    // Central
    cctx.clearRect(0,0,sw,bandH);
    cctx.drawImage(full, sx, syC, sw, bandH, 0, 0, sw, bandH);

    hint.textContent = 'Buscando c√≥digo de barras‚Ä¶';
    document.getElementById('takePhoto1DBtn').disabled = true;

    let ok = false;
    // 1) Full
    ok = ok || await decodeCode128FromCanvas(full);
    // 2) Central 33%
    ok = ok || await decodeCode128FromCanvas(crop);
    // 3) Full rotado 90¬∞
    ok = ok || await decodeCode128FromCanvas(rotatedCanvas(full));
    // 4) Banda superior 33%
    if(!ok){
      cctx.clearRect(0,0,sw,bandH);
      cctx.drawImage(full, sx, syT, sw, bandH, 0, 0, sw, bandH);
      ok = ok || await decodeCode128FromCanvas(crop);
    }
    // 5) Banda inferior 33%
    if(!ok){
      cctx.clearRect(0,0,sw,bandH);
      cctx.drawImage(full, sx, syB, sw, bandH, 0, 0, sw, bandH);
      ok = ok || await decodeCode128FromCanvas(crop);
    }
    // 6) Banda central rotada
    if(!ok){
      cctx.clearRect(0,0,sw,bandH);
      cctx.drawImage(full, sx, syC, sw, bandH, 0, 0, sw, bandH);
      ok = ok || await decodeCode128FromCanvas(rotatedCanvas(crop));
    }

    if(!ok){
      hint.innerHTML = 'No se encontr√≥ un Code 128 en la foto. Prob√° acercarte, alinear mejor o reintentar.';
      retry.style.display = 'inline-block';
      document.getElementById('takePhoto1DBtn').disabled = false;
    }
  }catch(e){
    hint.innerHTML = 'Ocurri√≥ un error al procesar la imagen.';
    document.getElementById('takePhoto1DBtn').disabled = false;
  }finally{
    decoding1D = false;
  }
}

function rotatedCanvas(srcCanvas){
  const dst = document.createElement('canvas');
  dst.width = srcCanvas.height;
  dst.height = srcCanvas.width;
  const dctx = dst.getContext('2d', { willReadFrequently: true });
  dctx.save();
  dctx.translate(dst.width/2, dst.height/2);
  dctx.rotate(Math.PI/2);
  dctx.drawImage(srcCanvas, -srcCanvas.width/2, -srcCanvas.height/2);
  dctx.restore();
  return dst;
}

function decodeCode128FromCanvas(cv){
  return new Promise((resolve) => {
    if(!window.Quagga || !cv) return resolve(false);
    try{
      const dataUrl = cv.toDataURL('image/png');
      window.Quagga.decodeSingle({
        src: dataUrl,
        numOfWorkers: 0,
        inputStream: { size: 800 },
        locator: { patchSize: 'medium', halfSample: true },
        decoder: { readers: ['code_128_reader'] }
      }, (result) => {
        try{
          const raw = (result && result.codeResult && result.codeResult.code) ? String(result.codeResult.code).trim() : '';
          if(raw){
            const id = extractIdFromAny(raw);
            if(id){ closeScan1DModal().then(()=>{ gotoId(id); }); return resolve(true); }
          }
          resolve(false);
        }catch{ resolve(false); }
      });
    }catch{ resolve(false); }
  });
}

async function closeScan1DModal(){
  const modal = document.getElementById('scan1DModal');
  const video = document.getElementById('scan1DVideo');
  const still = document.getElementById('scan1DStill');
  const guide = document.querySelector('#scan1DModal .scan-guide');

  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');

  try{ video.pause && video.pause(); }catch{}
  if (still) still.style.display = 'none';
  if (video) video.style.display = '';
  if (guide) guide.style.display = '';

  if(video && video.srcObject){
    try{ video.srcObject.getTracks().forEach(t=>t.stop()); }catch{}
    video.srcObject = null;
  }
  if(scan1DStream){
    try{ scan1DStream.getTracks().forEach(t=>t.stop()); }catch{}
    scan1DStream = null;
  }
}

    // ====== QR (sin cambios) ======
    let scanStream = null;
    let scanRaf = 0;
    let barcodeDetector = null;

    async function openScanModal(){
      const modal = document.getElementById('scanModal');
      const video = document.getElementById('scanVideo');
      const hint  = document.getElementById('scanHint');
      const canvas= document.getElementById('scanCanvas');
      const ctx   = canvas.getContext('2d', { willReadFrequently:true });

      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');

      try{
        // BarcodeDetector si est√° disponible (primero intenta QR+Code128, si falla usa QR solo)
        if('BarcodeDetector' in window){
          try{
            barcodeDetector = new BarcodeDetector({ formats: ['qr_code','code_128'] });
          }catch{
            try{ barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] }); }catch{ barcodeDetector = null; }
          }
        }else{
          barcodeDetector = null;
        }

        // C√°mara
        scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = scanStream;

        // üîß Asegurar que el video se vea y arranque
        video.style.display = '';
        try { await video.play(); } catch {}
        await new Promise(r => { if (video.readyState >= 1) r(); else video.onloadedmetadata = r; });

        // Bucle de lectura
        const useJsQR = !barcodeDetector && typeof window.jsQR === 'function';
        if(!barcodeDetector && !useJsQR){
          hint.innerHTML = 'Tu navegador no soporta detecci√≥n nativa. Us√° "Pegar" o escrib√≠ el ID. (QR fallback requiere jsQR)';
        }

        const loop = async () => {
          try{
            if(barcodeDetector){
              const codes = await barcodeDetector.detect(video);
              if(codes && codes.length){
                const raw = (codes[0].rawValue||'').trim();
                const id = extractIdFromAny(raw);
                if(id){ await closeScanModal(); gotoId(id); return; }
              }
            }else if(useJsQR){
              const vw = video.videoWidth, vh = video.videoHeight;
              if(vw && vh){
                canvas.width = vw; canvas.height = vh;
                ctx.drawImage(video, 0, 0, vw, vh);
                const img = ctx.getImageData(0,0,vw,vh);
                const qr = window.jsQR && window.jsQR(img.data, vw, vh, { inversionAttempts:'attemptBoth' });
                if(qr && qr.data){
                  const id = extractIdFromAny(qr.data);
                  if(id){ await closeScanModal(); gotoId(id); return; }
                }
              }
            }
          }catch(e){
            // ignoramos, seguimos intentando
          }
          scanRaf = requestAnimationFrame(loop);
        };
        scanRaf = requestAnimationFrame(loop);

      }catch(err){
        hint.innerHTML = 'No se pudo acceder a la c√°mara. Verific√° permisos o us√° "Pegar".';
      }

      // acciones cierre
      document.getElementById('scanStopBtn').onclick = closeScanModal;
      document.getElementById('closeScanBtn').onclick = closeScanModal;
      modal.addEventListener('click', (e)=>{ if(e.target === modal) closeScanModal(); });
    }

    async function closeScanModal(){
      const modal = document.getElementById('scanModal');
      const video = document.getElementById('scanVideo');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      if(scanRaf) cancelAnimationFrame(scanRaf);
      scanRaf = 0;
      if(video) { video.pause && video.pause(); video.style.display=''; }
      if(scanStream){
        scanStream.getTracks().forEach(t=>t.stop());
        scanStream = null;
      }
    }

    // Go
    main();
  </script>
</body>
</html>
































