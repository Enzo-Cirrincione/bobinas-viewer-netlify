<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Ficha de bobina</title>
<meta name="color-scheme" content="light dark" />
<style>
/* ========================================================
   VARIABLES MODERNAS Y AJUSTES DE TONALIDAD (MÁS 'CANCHERO')
   ======================================================== */
  :root{
    /* Paleta Oscura (Más contraste y profundidad) */
    bg: #0d1117; /* Fondo más oscuro */
    card: #161b22; /* Card principal más claro que el fondo */
    card2: #161b22; /* Se elimina el degradado sutil en la card */
    text: #f0f6fc; /* Texto blanco brillante */
    muted: #8b949e; /* Texto tenue */
    accent: #2196f3; /* Azul primario más vibrante */
    accent-2: #1976d2; /* Variante del azul */
    ok: #3fb950; /* Verde de éxito */
    err: #f85149; /* Rojo de error */
    warn: #ff9d00; /* Naranja de advertencia */
    border: #30363d; /* Bordes sutiles */
    shadow: 0 4px 12px rgba(0,0,0,.45); /* Sombra más pronunciada y suave */
    radius: 12px; /* Radio ligeramente más pequeño para un look más definido */
    transition: 0.2s ease; /* Transición para efectos hover */
  }
  @media (prefers-color-scheme: light){
    /* Paleta Clara (Más limpia y aireada) */
    :root{
      bg:#ffffff;
      card:#f6f8fa;
      card2:#f6f8fa;
      text:#24292f;
      muted:#6e7781;
      accent:#0366d6;
      accent-2:#005cc5;
      ok:#22863a;
      err:#cb2431;
      warn:#d73a49;
      border:#eaecef;
      shadow:0 4px 12px rgba(27,31,35,0.1);
    }
  }
  /* ========================================================
     BASE
     ======================================================== */
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    /* Fuente: Usa la más moderna del sistema */
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    line-height: 1.5;
  }
  .wrap{
    max-width:1080px; /* Un poco más ancho */
    margin:0 auto;
    padding:24px; /* Más espaciado */
    display:grid;
    gap:24px; /* Más espacio entre tarjetas */
  }
  /* ========================================================
     COMPONENTES (CARDS, BOTONES, INPUTS)
     ======================================================== */
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:20px; /* Más padding interno */
    transition: box-shadow var(--transition);
  }
  .card:hover{
    box-shadow: 0 8px 25px rgba(0,0,0,.30); /* Sombra al pasar el ratón */
  }
  .title{
    margin:0 0 16px;
    font-size:24px;
    font-weight:700;
    letter-spacing:-0.5px; /* Más ajustado */
    display:flex;
    align-items:center;
    gap:12px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 12px;
  }
  .badge{
    display:inline-flex;
    gap:6px;
    align-items:center;
    padding:4px 10px;
    border:1px solid var(--border);
    border-radius:999px;
    font-weight:600;
    font-size:14px;
    color:var(--muted);
  }
  .muted{ color:var(--muted) } .ok{ color:var(--ok) } .err{ color:var(--err) }
  .k{
    color:var(--muted);
    min-width:140px;
    display:inline-block;
    font-weight:500;
  }
  .code-big{
    font-weight:700; /* No tan gruesa como 900 */
    font-size:26px;
    letter-spacing:0;
    color:var(--accent);
  }
  .grid{ display:grid; gap:20px } /* Más espacio en las grillas */
  .field{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
  .field-col{ display:grid; gap:16px } /* Más espacio en columnas */
  /* Botón Principal (Más pop) */
  .btn{
    padding:12px 18px;
    border-radius:10px;
    border:none; /* Se quita el border transparente */
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    color:var(--text); /* Cambia el color del texto a la variable principal (blanco o negro) */
    font-weight:700;
    cursor:pointer;
    box-shadow:0 8px 20px color-mix(in srgb, var(--accent) 30%, transparent); /* Sombra más sutil y del color del acento */
    transition: transform var(--transition), box-shadow var(--transition);
  }
  .btn:hover:not([disabled]){
    transform: translateY(-1px);
    box-shadow:0 12px 25px color-mix(in srgb, var(--accent) 40%, transparent);
  }
  /* Botón Ghost (Más sutil) */
  .btn-ghost{
    padding:8px 12px;
    border-radius:8px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--accent); /* Color de acento para el texto */
    font-weight:600;
    cursor:pointer;
    transition: background-color var(--transition);
  }
  .btn-ghost:hover:not([disabled]){
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
  /* Inputs y Selects */
  .input, select, textarea{
    width:100%;
    padding:12px 14px;
    border:1px solid var(--border);
    border-radius:8px; /* Ligeramente más pequeños */
    background:var(--bg); /* Fondo del input igual al body */
    color:var(--text);
    font-size:16px;
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  .input:focus, select:focus, textarea:focus{
    border-color: var(--accent);
    outline: none;
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 30%, transparent);
  }
  textarea{ resize:vertical }
  .inline-edit{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
    margin-top: 8px; /* Separación de la línea */
  }
  .hero-img{
    width:100%;
    max-height:42vh;
    object-fit:contain;
    border:1px solid var(--border);
    border-radius:var(--radius);
    background:var(--bg); /* Fondo de la imagen al color del body */
  }
  details > summary{ list-style:none; cursor:pointer; user-select:none; padding:8px 0; display:flex; align-items:center; gap:8px }
  details > summary::-webkit-details-marker{ display:none; }
  .caret{ transition:transform .2s ease; display:inline-block; color:var(--accent); font-weight:700 }
  details[open] .caret{ transform:rotate(90deg) }
  .alert-warn{
    border-left: 5px solid var(--warn); /* Borde lateral para llamar la atención */
    box-shadow: 0 0 0 1px color-mix(in srgb, var(--warn) 30%, transparent);
  }
  .alert-danger{
    border-left: 5px solid var(--err);
    box-shadow: 0 0 0 1px color-mix(in srgb, var(--err) 30%, transparent);
  }

  /* Skeleton (Mantiene el mismo efecto shimmer) */
  @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
  .skeleton{ border-radius:6px; min-height:1.5em; color:transparent !important;
    background:linear-gradient(90deg, rgba(200,205,215,.15) 25%, rgba(200,205,215,.35) 37%, rgba(200,205,215,.15) 63%);
    background-size:400% 100%; animation: shimmer 1.2s infinite linear; }
  .skel-img{ border:1px solid var(--border); border-radius:var(--radius); width:100%; height:42vh;
    background:linear-gradient(90deg, rgba(200,205,215,.15) 25%, rgba(200,205,215,.35) 37%, rgba(200,205,215,.15) 63%);
    background-size:400% 100%; animation: shimmer 1.2s infinite linear; }

  @media (max-width:768px){
    .wrap { padding: 16px; }
  }
  @media (max-width:640px){
    .k{ min-width:100px }
    .code-big{ font-size:24px }
    .title{ font-size:22px }
    .field{ display:block; } /* Para móviles, cada campo en su propia línea */
    .k{ display:block; margin-bottom: 4px; }
  }
</style>
</head>
<body>
<div class="wrap">

    <section id="cardDatos" class="card">
      </section>

    <section class="card">
      </section>

    <section class="card">
      </section>

    <div id="status" class="muted" style="display:none"></div>
</div>

<script>
  /* =========================
     CONFIG: Pega tus URLs de Flow
     ========================= */
  const CFG = {
    GET_BOBINA_URL:   'https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ddf0b0a84bda4428b59d464812b6b734/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=SylYZCLZTHEF4kj1OD9YCpCGAfUuA2T5R8dS5rvD25s&',   // acepta ?id=...
    POST_UPDATE_URL:  '/api/update',   // HTTP POST
    POST_DEV_URL:     '/api/devolucion'// HTTP POST
  };

/* ====== helpers ====== */
const qs = (n)=>new URLSearchParams(location.search).get(n);
function showStatus(msg, isError=false){
  const el = document.getElementById('status'); if(!el) return;
  el.style.display='block'; el.innerHTML = isError ? `<span class="err">${msg}</span>` : msg;
}
function hideStatus(){ const el=document.getElementById('status'); if(!el) return; el.innerHTML=''; el.style.display='none'; }
function setLoading(btn,on,labelBusy){ if(!btn) return; if(on){ btn.disabled=true; btn.dataset.label=btn.textContent; btn.textContent=labelBusy||'Procesando…'; } else { btn.disabled=false; btn.textContent=btn.dataset.label||btn.textContent; } }
function excelSerialToDMY(v){ const n=Number(v); if(!isFinite(n)||n<=0) return (v||''); const d=new Date(Math.round((n-25569)*86400*1000)); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
function parseDateMaybe(x){ if(x==null||x==='') return null; if(/^\d+(\.\d+)?$/.test(String(x))){ const t=Math.round((Number(x)-25569)*86400*1000); return new Date(t); } const d=new Date(x); return isNaN(d)?null:d; }
function yearsDiff(a,b){ return (b-a)/(365.25*24*3600*1000); }
function normSP(u){ if(!u) return u; u=u.replace(/%2520/g,'%20'); try{ const url=new URL(u); if(url.pathname.startsWith('/:u:/')||url.pathname.startsWith('/:i:/')||url.pathname.startsWith('/:x:/')){ if(!url.searchParams.has('download')) url.searchParams.set('download','1'); return url.toString(); } if(url.pathname.includes('/Forms/AllItems.aspx')){ const idParam=url.searchParams.get('id'); if(idParam){ const decoded=decodeURIComponent(idParam); const base=url.origin+'/sites/ALMACENPRE-PRODUCCION/_layouts/15/download.aspx?SourceUrl='; return base+encodeURIComponent(decoded); } } return u; }catch{ return u; } }
function toggleSkeleton(on=true){
  document.querySelectorAll('[data-skel]').forEach(el=>{ if(on){ el.classList.add('skeleton'); el.textContent=' '; } else { el.classList.remove('skeleton'); } });
  const sk=document.getElementById('imgSkel'); if(sk) sk.style.display = on ? 'block' : 'none';
}

/* ====== estado ====== */
let DATA = {};

/* ====== render ====== */
function render(d){
  const g=(k,alts=[])=>{ if(d[k]!=null && d[k]!=='') return d[k]; for(const a of alts) if(d[a]!=null && d[a]!=='') return d[a]; return ''; };

  const idFila = g('ID_FILA');
  const codigo = g('CODIGO',['CÓDIGO']);
  const desc   = g('DESCRIPCION',['DESCRIPCIÓN']);
  const fIng   = g('FECHA_INGRESO',['FECHA INGRESO']);
  const cant   = g('CANTIDAD');
  const prov   = g('PROVEEDOR');
  const ubi    = g('UBICACION_ALMACEN',['UBICACIÓN']);
  const est    = g('ESTADO');
  const fDev   = g('FECHA_DEVOLUCION',['FECHA DEVOLUCIÓN']);
  const linea  = g('ULTIMA_LINEA',['LINEA']);
  const obs    = g('OBSERVACION',['OBSERVACIÓN']);
  const imgURL = g('IMAGEN_URL');

  // título
  const badge = document.getElementById('badgeId'); if(badge) badge.textContent = `ID: ${idFila||'—'}`;

  // básicos
  const setTxt = (id,val)=>{ const el=document.getElementById(id); if(!el) return; el.textContent = val; el.classList.remove('skeleton'); };
  setTxt('CODIGO', codigo||'—');
  setTxt('DESCRIPCION', desc||'—');
  setTxt('CANTIDAD', (cant??'')===''?'—':String(cant));
  setTxt('PROVEEDOR', prov||'—');
  setTxt('UBICACION_ALMACEN', ubi||'—');
  setTxt('ESTADO', est||'—');
  setTxt('ULTIMA_LINEA', linea||'—');
  setTxt('OBSERVACION', obs||'—');

  // fechas
  const fmt = v => (/^\d+(\.\d+)?$/.test(String(v))) ? excelSerialToDMY(v) : (v||'—');
  setTxt('FECHA_INGRESO', fmt(fIng));
  setTxt('FECHA_DEVOLUCION', fmt(fDev));

  // alertas: BAJA (fuerte) / antigüedad (tenue)
  const card = document.getElementById('cardDatos');
  if(card){ card.classList.remove('alert-warn','alert-danger');
    if(String(est).toUpperCase()==='BAJA'){ card.classList.add('alert-danger'); }
    else { const di=parseDateMaybe(fIng); if(di && yearsDiff(di,new Date())>=2){ card.classList.add('alert-warn'); } }
  }

  // imagen con skeleton
  const imgEl = document.getElementById('imgEtiqueta');
  const imgSk = document.getElementById('imgSkel');
  const imgStatus = document.getElementById('imgStatus');
  const linkW = document.getElementById('imgLinkWrap');
  if(linkW) linkW.innerHTML = '';
  if(imgStatus) imgStatus.textContent = '';

  if (imgURL && imgEl){
    const u = normSP(imgURL);
    if(imgSk) imgSk.style.display='block';
    imgEl.style.display='none';
    imgEl.onload = ()=>{ if(imgSk) imgSk.style.display='none'; imgEl.style.display='block'; if(imgStatus) imgStatus.textContent=''; };
    imgEl.onerror= ()=>{ if(imgSk) imgSk.style.display='none'; imgEl.style.display='none'; if(imgStatus) imgStatus.textContent='No disponible'; };
    imgEl.src = u;
    if(linkW) linkW.innerHTML = `<a href="${u}" target="_blank" rel="noreferrer">Abrir imagen completa</a>`;
  }else{
    if(imgSk) imgSk.style.display='none';
    if(imgEl) imgEl.style.display='none';
    if(imgStatus) imgStatus.textContent='No disponible';
  }

  // preparar inputs
  const ic=document.getElementById('editCantInput'); if(ic) ic.value = cant || 0;
  const iu=document.getElementById('editUbicInput'); if(iu) iu.value = ubi || '';
  const ie=document.getElementById('editEstadoInput'); if(ie) ie.value = est || '';
}

/* ====== fetch ====== */
async function getBobina(id){
  const url = `${CFG.GET_BOBINA_URL}id=${encodeURIComponent(id)}&_=${Date.now()}`;
  const r = await fetch(url, { headers:{Accept:'application/json'}, cache:'no-store' });
  const txt = await r.text();
  let data; try{ data=JSON.parse(txt) }catch{ data=null }
  if(!r.ok) throw new Error(`HTTP ${r.status}: ${txt.slice(0,220)}`);
  if(!data) throw new Error(`Respuesta no es JSON: ${txt.slice(0,220)}`);
  if(data.error) throw new Error(typeof data.error==='string'?data.error:JSON.stringify(data.error));
  return data;
}
async function postUpdate(payload){
  const r = await fetch(CFG.POST_UPDATE_URL, { method:'POST', headers:{'Content-Type':'application/json',Accept:'application/json'}, body:JSON.stringify(payload) });
  const t = await r.text(); if(!r.ok) throw new Error(`HTTP ${r.status}: ${t.slice(0,220)}`); return t;
}
async function postDevolucion(payload){
  const r = await fetch(CFG.POST_DEV_URL, { method:'POST', headers:{'Content-Type':'application/json',Accept:'application/json'}, body:JSON.stringify(payload) });
  const t = await r.text(); if(!r.ok) throw new Error(`HTTP ${r.status}: ${t.slice(0,220)}`); return t;
}

/* ====== main ====== */
async function main(){
  const id = qs('id'); if(!id){ showStatus("Falta parámetro 'id'", true); return; }
  toggleSkeleton(true); showStatus('Cargando ficha…');
  try{ DATA = await getBobina(id); render(DATA); hideStatus(); }
  catch(e){ showStatus(e?.message||'Error al cargar', true); }
  finally{ toggleSkeleton(false); }
}

/* ====== eventos (editar/guardar) ====== */
const E = (id)=>document.getElementById(id);

E('editCantBtn').onclick = ()=>{ E('editCantWrap').style.display='flex'; };
E('cancelCantBtn').onclick = ()=>{ E('editCantWrap').style.display='none'; E('editCantStatus').textContent=''; };
E('saveCantBtn').onclick = async (ev)=>{
  const st=E('editCantStatus'); st.textContent=''; const v=Number(E('editCantInput').value);
  if(isNaN(v)||v<0){ st.innerHTML='<span class="err">Cantidad inválida.</span>'; return; }
  try{ setLoading(ev.currentTarget,true,'Guardando…'); await postUpdate({ id: qs('id'), updates:{ CANTIDAD:v } }); st.innerHTML='<span class="ok">Guardado.</span>'; await main(); E('editCantWrap').style.display='none'; }
  catch(err){ st.innerHTML=`<span class="err">${err.message||err}</span>`; }
  finally{ setLoading(ev.currentTarget,false); }
};

E('editUbicBtn').onclick = ()=>{ E('editUbicWrap').style.display='flex'; };
E('cancelUbicBtn').onclick = ()=>{ E('editUbicWrap').style.display='none'; E('editUbicStatus').textContent=''; };
E('saveUbicBtn').onclick = async (ev)=>{
  const st=E('editUbicStatus'); const v=(E('editUbicInput').value||'').trim(); if(!v){ st.innerHTML='<span class="err">Ingresá una ubicación.</span>'; return; }
  try{ setLoading(ev.currentTarget,true,'Guardando…'); await postUpdate({ id: qs('id'), updates:{ UBICACION_ALMACEN:v } }); st.innerHTML='<span class="ok">Guardado.</span>'; await main(); E('editUbicWrap').style.display='none'; }
  catch(err){ st.innerHTML=`<span class="err">${err.message||err}</span>`; }
  finally{ setLoading(ev.currentTarget,false); }
};

E('editEstadoBtn').onclick = ()=>{ E('editEstadoWrap').style.display='flex'; };
E('cancelEstadoBtn').onclick = ()=>{ E('editEstadoWrap').style.display='none'; E('editEstadoStatus').textContent=''; };
E('saveEstadoBtn').onclick = async (ev)=>{
  const st=E('editEstadoStatus'); const v=E('editEstadoInput').value;
  try{ setLoading(ev.currentTarget,true,'Guardando…'); await postUpdate({ id: qs('id'), updates:{ ESTADO:v } }); st.innerHTML='<span class="ok">Guardado.</span>'; await main(); E('editEstadoWrap').style.display='none'; }
  catch(err){ st.innerHTML=`<span class="err">${err.message||err}</span>`; }
  finally{ setLoading(ev.currentTarget,false); }
};

/* ====== devolución ====== */
E('sendDevBtn').onclick = async (ev)=>{
  const st=E('devStatus'); st.textContent='';
  const cantidad = Number(E('devCant').value);
  const linea = E('devLinea').value;
  const usuario = E('devUsuario').value;
  const observacion = (E('devObs').value||'').trim();
  if(isNaN(cantidad)||cantidad<=0){ st.innerHTML='<span class="err">Cantidad inválida.</span>'; return; }
  if(!linea){ st.innerHTML='<span class="err">Elegí una línea.</span>'; return; }
  if(!usuario){ st.innerHTML='<span class="err">Elegí un usuario.</span>'; return; }

  try{
    setLoading(ev.currentTarget,true,'Enviando…');
    localStorage.setItem('lastUser', usuario);
    localStorage.setItem('lastLinea', linea);
    await postDevolucion({ id: qs('id'), cantidad_devuelta:cantidad, linea, observacion, usuario });
    st.innerHTML='<span class="ok">Devolución registrada.</span>';
    E('devCant').value=''; E('devLinea').value=''; E('devUsuario').value=''; E('devObs').value='';
    await main();
  }catch(err){ st.innerHTML=`<span class="err">${err.message||err}</span>`; }
  finally{ setLoading(ev.currentTarget,false); }
};

/* precarga usuario/línea preferidos */
(function(){
  const u=localStorage.getItem('lastUser'); if(u) { const el=E('devUsuario'); if(el) el.value=u; }
  const l=localStorage.getItem('lastLinea'); if(l){ const el=E('devLinea'); if(el) el.value=l; }
})();

/* go */
main();
</script>
</body>
</html>

