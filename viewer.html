<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viewer con Lector Code 128</title>

  <!--
    Este archivo es un ejemplo de integración del lector Code 128 con Quagga2.
    Podés copiar solamente los bloques marcados como "INYECCIÓN" dentro de tu viewer.html existente.
    Si ya tenés un <header> con un input #idInput, el lector lo completará automáticamente.
  -->

  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121922;
      --text: #e7edf5;
      --muted: #8ea0b5;
      --accent: #4da3ff;
      --danger: #ff5d6c;
      --border: #203040;
    }
    html, body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .row {display:flex; align-items:center; gap:8px}
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .input {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
    }
    .btn {
      cursor: pointer;
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 600;
      background: var(--accent);
      color: #07111a;
    }
    .btn-ghost {
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--text);
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }

    /* INYECCIÓN: Estilos del modal / visor del escáner */
    .scanner-fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 30;
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--accent);
      color: #03121f;
      border: none;
      box-shadow: 0 10px 22px rgba(0,0,0,.4);
      font-weight: 700;
    }
    .scanner-modal {
      position: fixed;
      inset: 0;
      background: rgba(3, 10, 18, .8);
      backdrop-filter: blur(3px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .scanner-modal.open { display: flex; }
    .scanner-card {
      width: min(720px, 92vw);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 20px 40px rgba(0,0,0,.45);
    }
    .scanner-head {
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .scanner-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
    }
    .scanner-viewport {
      width: 100%;
      height: min(60vh, 420px);
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    .scanner-help {
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
    }
    .scanner-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      border: 2px dashed rgba(255,255,255,.25);
      border-radius: 12px;
      box-shadow: inset 0 0 0 9999px rgba(0,0,0,.25);
    }
    .hidden { display: none !important; }
    @media (max-width: 640px){
      .scanner-card { padding: 10px; }
    }
  </style>
</head>
<body>

  <!-- Ejemplo de header. Si tu viewer ya tiene uno, mantené el tuyo -->
  <header>
    <div class="row">
      <span class="badge">Viewer</span>
      <form id="idForm" class="row" autocomplete="off" onsubmit="return false">
        <input id="idInput" class="input" name="id" placeholder="Ingresá ID… (ej. CQ1)" />
        <button class="btn-ghost btn" id="openScannerBtn" type="button">Escanear</button>
      </form>
    </div>
    <div class="row">
      <button class="btn-ghost btn" id="copyLinkBtn" type="button">Copiar enlace</button>
      <button class="btn" id="goBtn" type="button">Abrir</button>
    </div>
  </header>

  <main style="padding:16px">
    <p class="scanner-help">Tip: el botón “Escanear” abre la cámara y lee códigos de barra <strong>Code 128</strong>. Al detectar, se completa el ID y se navega automáticamente.</p>
  </main>

  <!-- INYECCIÓN: Modal del escáner -->
  <div id="scannerModal" class="scanner-modal" role="dialog" aria-modal="true" aria-labelledby="scannerTitle">
    <div class="scanner-card">
      <div class="scanner-head">
        <div class="scanner-title" id="scannerTitle">Escanear código de barras (Code 128)</div>
        <div class="row">
          <button id="toggleTorchBtn" class="btn-ghost btn" type="button" title="Linterna">Linterna</button>
          <button id="closeScannerBtn" class="btn-ghost btn" type="button" title="Cerrar">Cerrar</button>
        </div>
      </div>
      <div id="scannerViewport" class="scanner-viewport">
        <div class="scanner-overlay"></div>
      </div>
      <div class="scanner-help">
        Recomendado abrir en <strong>HTTPS</strong> o <code>localhost</code> para que el navegador permita el acceso a la cámara.
      </div>
    </div>
  </div>

  <!-- INYECCIÓN: Botón FAB (por si tu layout no muestra el header) -->
  <button id="scannerFab" class="scanner-fab" type="button">Escanear</button>

  <!-- INYECCIÓN: Biblioteca Quagga2 (lector Code 128). Si ya usás un bundler, importá @ericblade/quagga2 en tu build. -->
  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>

  <script>
    // Utilidad: obtener/poner el ID por URL (?id=...)
    function getCurrentIdFromURL() {
      const u = new URL(window.location.href);
      return (u.searchParams.get("id") || "").trim();
    }
    function navigateToId(id) {
      const next = new URL(window.location.href);
      next.searchParams.set("id", id);
      window.location.href = next.toString();
    }

    // Historial simple
    function pushRecentId(id) {
      try {
        const k = "recentIds";
        const list = JSON.parse(localStorage.getItem(k) || "[]");
        if (!list.includes(id)) {
          list.unshift(id);
        }
        while (list.length > 20) list.pop();
        localStorage.setItem(k, JSON.stringify(list));
      } catch (e) {}
    }

    // === INYECCIÓN: Lector Code 128 con Quagga2 ===
    const scannerModal = document.getElementById("scannerModal");
    const openScannerBtn = document.getElementById("openScannerBtn");
    const closeScannerBtn = document.getElementById("closeScannerBtn");
    const scannerFab = document.getElementById("scannerFab");
    const viewport = document.getElementById("scannerViewport");
    const toggleTorchBtn = document.getElementById("toggleTorchBtn");

    let torchOn = false;
    let currentTrack = null;
    let quaggaReady = false;
    let onDetectedHandler = null;

    function openScanner() {
      scannerModal.classList.add("open");
      document.body.style.overflow = "hidden";

      const constraints = {
        facingMode: "environment",
        ...(window.innerWidth < 700 ? { aspectRatio: { ideal: 16/9 } } : {}),
        // Torch es experimental y depende del device
        ...(torchOn ? { advanced: [{ torch: true }] } : {}),
      };

      // Configurar Quagga
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: viewport,
          willReadFrequently: true,
          constraints
        },
        locator: { patchSize: "medium", halfSample: true },
        numOfWorkers: (navigator.hardwareConcurrency || 4),
        frequency: 10,
        decoder: {
          readers: ["code_128_reader"] // <- Code 128
        }
      }, function(err){
        if (err) {
          console.error(err);
          alert("No se pudo iniciar la cámara: " + err.message);
          closeScanner();
          return;
        }
        quaggaReady = true;
        Quagga.start();

        // Guardar el track para controlar linterna si está soportada
        const stream = Quagga.cameraAccess.getActiveStream();
        if (stream) {
          currentTrack = stream.getVideoTracks()[0] || null;
          // Intentar torch si estaba habilitado
          if (torchOn && currentTrack && currentTrack.applyConstraints) {
            currentTrack.applyConstraints({ advanced: [{ torch: true }] }).catch(()=>{});
          }
        }

        onDetectedHandler = function(data){
          const code = (data && data.codeResult && data.codeResult.code || "").trim();
          if (!code) return;
          // Filtrar falsos positivos (opcional): longitud mínima 2
          if (code.length < 2) return;
          handleDetectedCode(code);
        };
        Quagga.onDetected(onDetectedHandler);
      });
    }

    function stopTorch() {
      if (!currentTrack) return;
      try {
        currentTrack.applyConstraints({ advanced: [{ torch: false }] });
      } catch (e) {}
    }

    function closeScanner() {
      document.body.style.overflow = "";
      scannerModal.classList.remove("open");

      try {
        if (onDetectedHandler) Quagga.offDetected(onDetectedHandler);
      } catch (e) {}

      try { Quagga.stop(); } catch (e) {}
      stopTorch();
      currentTrack = null;
      quaggaReady = false;
    }

    function handleDetectedCode(code) {
      // Cerrar primero para detener cámara
      closeScanner();

      // Normalización básica: quitar espacios
      const id = code.replace(/\s+/g, "");
      const input = document.getElementById("idInput");

      pushRecentId(id);
      if (input) {
        input.value = id;
        // si tenés un formulario que navega, disparalo:
        navigateToId(id);
      } else {
        // Fallback: navegar directo
        navigateToId(id);
      }
    }

    function toggleTorch() {
      torchOn = !torchOn;
      toggleTorchBtn.textContent = torchOn ? "Linterna: ON" : "Linterna";
      if (currentTrack && currentTrack.applyConstraints) {
        currentTrack.applyConstraints({ advanced: [{ torch: torchOn }] }).catch(()=>{});
      }
    }

    // Eventos UI
    openScannerBtn?.addEventListener("click", openScanner);
    scannerFab?.addEventListener("click", openScanner);
    closeScannerBtn?.addEventListener("click", closeScanner);
    toggleTorchBtn?.addEventListener("click", toggleTorch);
    scannerModal?.addEventListener("click", (e)=>{
      if (e.target === scannerModal) closeScanner();
    });
    window.addEventListener("keydown", (e)=>{
      if (e.key === "Escape" && scannerModal.classList.contains("open")) {
        closeScanner();
      }
    });

    // Botones de navegación del header de ejemplo
    document.getElementById("goBtn")?.addEventListener("click", ()=>{
      const v = document.getElementById("idInput")?.value?.trim();
      if (v) navigateToId(v);
    });
    document.getElementById("copyLinkBtn")?.addEventListener("click", async ()=>{
      const v = document.getElementById("idInput")?.value?.trim() || getCurrentIdFromURL();
      if (!v) return alert("No hay ID para copiar.");
      const url = new URL(window.location.href);
      url.searchParams.set("id", v);
      try {
        await navigator.clipboard.writeText(url.toString());
        alert("Enlace copiado");
      } catch (e) {
        prompt("Copiá el enlace:", url.toString());
      }
    });

    // Precargar valor si viene por URL
    (function bootstrap(){
      const id = getCurrentIdFromURL();
      const input = document.getElementById("idInput");
      if (id && input) input.value = id;
    })();
  </script>
</body>
</html>







