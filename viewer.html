<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bobinas • Viewer</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #0b0e14;
      --card: #111520;
      --muted: #97a3b6;
      --text: #e6edf6;
      --accent: #4f46e5;
      --accent-2: #22c55e;
      --border: #1c2233;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f8fb;
        --card: #ffffff;
        --muted: #64748b;
        --text: #0f172a;
        --accent: #4f46e5;
        --accent-2: #16a34a;
        --border: #e5e7eb;
        --danger: #dc2626;
        --shadow: 0 10px 30px rgba(2,6,23,.08);
      }
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; padding:24px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(79,70,229,.20), transparent 40%),
        radial-gradient(1000px 700px at 110% 10%, rgba(34,197,94,.12), transparent 45%),
        var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 960px; margin:0 auto; display:grid; gap:16px }
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding:16px 20px; border:1px solid var(--border); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--card);
      box-shadow: var(--shadow);
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:700; letter-spacing:.2px;
    }
    .brand .dot{ width:10px; height:10px; border-radius:999px; background:var(--accent) }
    .id-badge{
      display:inline-flex; align-items:center; gap:8px; flex-wrap:wrap;
      padding:6px 10px; border-radius:999px; background: rgba(79,70,229,.12); color: var(--text);
      border:1px solid rgba(79,70,229,.35); font-weight:600; font-size:13px;
    }
    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr } }
    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      padding:18px;
      box-shadow: var(--shadow);
    }
    .title{ margin:0 0 10px; font-size:22px; font-weight:800; letter-spacing:.2px; }
    .rows{ display:grid; gap:10px }
    .row{ display:flex; align-items:baseline; gap:10px; line-height:1.35 }
    .row b{ min-width: 190px; font-weight:700; color: var(--muted); }
    .muted{ color: var(--muted) }
    .error{ color: var(--danger) }
    a{ color:var(--accent); text-decoration: none }
    a:hover{ text-decoration: underline }
    .hero-img{
      width:100%; max-height:360px; object-fit:contain;
      border-radius:12px; border:1px solid var(--border); background: #0b0f19;
    }
    .btn{
      appearance:none; border:1px solid transparent; border-radius:10px;
      padding:10px 14px; font-weight:700; cursor:pointer;
      background:var(--accent); color:white; box-shadow: 0 6px 20px rgba(79,70,229,.35);
      transition: transform .04s ease, filter .15s ease, box-shadow .15s ease;
    }
    .btn:hover{ filter:brightness(1.05); box-shadow:0 10px 26px rgba(79,70,229,.45) }
    .btn:active{ transform: translateY(1px) }
    .btn-ghost{
      background:transparent; border-color:var(--border); color:var(--text);
      box-shadow:none;
    }
    .form-grid{ display:grid; gap:12px }
    .input{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:transparent; color:var(--text);
      outline:none;
    }
    .input::placeholder{ color: color-mix(in oklab, var(--muted) 80%, transparent) }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end }
    .status{ font-size:14px }
    .spacer{ height:4px }
    .skeleton{ height:14px; background: linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.02), rgba(255,255,255,.08)); border-radius:8px; animation: pulse 1.2s infinite }
    @keyframes pulse{ 0%{ background-position:-200px 0 } 100%{ background-position:200px 0 } }

    /* === Overlay de escaneo === */
    .scan-overlay{
      position: fixed; inset: 0; z-index: 50;
      background: rgba(0,0,0,.6);
      display: none; align-items: center; justify-content: center;
    }
    .scan-card{
      background: var(--card); color: var(--text);
      border:1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow);
      width:min(680px, 92%); padding:14px;
    }
    .scan-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .scan-video{ width:100%; border-radius:12px; border:1px solid var(--border); background:#000; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="dot"></div>
        <div>Bobinas • Viewer</div>
      </div>

      <!-- Badge EDITABLE + acciones -->
      <div id="badge" class="id-badge" style="gap:6px;">
        <span id="badgeLabel">ID:</span>
        <span id="badgeValue" title="Click para editar" style="cursor:text;">—</span>

        <input id="idInput" class="input" type="text" inputmode="text"
               placeholder="Ingresá ID o pega URL"
               style="display:none; width:200px; padding:6px 8px; font-weight:600" />

        <button id="openBtn"  class="btn"        style="display:none; padding:6px 10px;">Abrir</button>
        <button id="clearBtn" class="btn btn-ghost" style="display:none; padding:6px 10px;">Limpiar</button>
        <button id="scanBtn"  class="btn btn-ghost"  style="padding:6px 10px;">Escanear</button>
      </div>
    </header>

    <div class="grid">
      <!-- Ficha -->
      <section class="card" id="card" style="display:none">
        <h2 class="title">Ficha de bobina</h2>
        <div class="rows" id="rows"></div>
        <div class="spacer"></div>
        <div id="extra-links"></div>
      </section>

      <!-- Imagen + Acciones -->
      <aside class="card" id="media">
        <h2 class="title">Imagen</h2>
        <div id="imgWrap" class="muted">Cargando imagen…</div>
      </aside>
    </div>

    <!-- Devolución -->
    <section class="card" id="devolucion" style="display:none">
      <div class="toolbar" style="justify-content:space-between">
        <h2 class="title" style="margin:0">Cargar devolución</h2>
        <small class="muted">Actualiza stock y deja traza en T_DEVOLUCIONES</small>
      </div>
      <form id="devForm" class="form-grid">
        <div class="row">
          <b>CANTIDAD DEVUELTA</b>
          <input class="input" type="number" min="0" step="1" name="cantidad_devolucion" required placeholder="0">
        </div>
        <div class="row">
          <b>LÍNEA</b>
          <input class="input" type="text" name="linea" placeholder="Ej. L3">
        </div>
        <div class="row">
          <b>OBSERVACIÓN</b>
          <input class="input" type="text" name="observacion" placeholder="Motivo / nota">
        </div>
        <div class="row">
          <b>USUARIO</b>
          <input class="input" type="text" name="usuario" placeholder="(opcional)">
        </div>
        <div class="toolbar">
          <button type="submit" class="btn">Enviar devolución</button>
          <span id="devStatus" class="status muted"></span>
        </div>
      </form>
    </section>

    <div id="status" class="muted">Cargando…</div>
  </div>

  <!-- Overlay de escaneo (QR / Code128) -->
  <div id="scanOverlay" class="scan-overlay" aria-hidden="true">
    <div class="scan-card">
      <div class="scan-toolbar">
        <strong>Escanear código (QR / Code128)</strong>
        <button id="closeScanBtn" class="btn btn-ghost">Cancelar</button>
      </div>
      <video id="scanVideo" class="scan-video" autoplay playsinline></video>
      <div id="scanStatus" class="muted" style="margin-top:6px">Buscando…</div>
    </div>
  </div>

  <script>
    // ===== Endpoints Netlify =====
    const FLOW_GET_BOBINA_URL = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ddf0b0a84bda4428b59d464812b6b734/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=SylYZCLZTHEF4kj1OD9YCpCGAfUuA2T5R8dS5rvD25s";

    // ——— Helpers ———
    function getId() {
      const params = new URLSearchParams(window.location.search);
      const q = params.get('id');
      if (q) return q;
      const parts = window.location.pathname.split('/').filter(Boolean);
      return parts[parts.length - 1] || null;
    }

    function normalizeSharePointImageUrl(u) {
      if (!u) return u;
      u = u.replace(/%2520/g, '%20');
      try {
        const url = new URL(u);
        if (url.pathname.startsWith('/:u:/') || url.pathname.startsWith('/:i:/') || url.pathname.startsWith('/:x:/')) {
          if (!url.searchParams.has('download')) url.searchParams.set('download','1');
          return url.toString();
        }
        if (url.pathname.includes('/Forms/AllItems.aspx')) {
          const idParam = url.searchParams.get('id');
          if (idParam) {
            const decoded = decodeURIComponent(idParam);
            const base = url.origin + '/sites/ALMACENPRE-PRODUCCION/_layouts/15/download.aspx?SourceUrl=';
            return base + encodeURIComponent(decoded);
          }
        }
        return u;
      } catch { return u; }
    }

    function fieldRow(label, value) {
      return `<div class="row"><b>${label}:</b> ${value ?? ''}</div>`;
    }

    // ——— Badge editable + navegación por ID/URL ———
    function extractId(raw){
      if(!raw) return '';
      const s = String(raw).trim();
      try{
        const u = new URL(s);
        const qid = u.searchParams.get('id');
        if(qid) return qid.trim();
        const segs = u.pathname.split('/').filter(Boolean);
        if(segs.length) return segs[segs.length-1];
      }catch{ /* no es URL */ }
      return s;
    }
    function gotoId(id){
      const clean = extractId(id);
      if(!clean) return;
      const url = new URL(location.href);
      url.searchParams.set('id', clean);
      location.href = url.toString();
    }
    (function setupEditableBadge(){
      const spanVal = document.getElementById('badgeValue');
      const input   = document.getElementById('idInput');
      const openBtn = document.getElementById('openBtn');
      const clearBtn= document.getElementById('clearBtn');
      const scanBtn = document.getElementById('scanBtn');

      const currentId = (new URL(location.href)).searchParams.get('id') || '—';
      spanVal.textContent = currentId;

      function enterEdit(){
        spanVal.style.display = 'none';
        input.style.display = 'inline-block';
        openBtn.style.display = 'inline-block';
        clearBtn.style.display = 'inline-block';
        input.value = (currentId !== '—') ? currentId : '';
        input.focus(); input.select();
      }
      function exitEdit(){
        spanVal.style.display = 'inline';
        input.style.display = 'none';
        openBtn.style.display = 'none';
        clearBtn.style.display = 'none';
      }
      spanVal.addEventListener('click', enterEdit);
      clearBtn.addEventListener('click', ()=>{ input.value=''; input.focus(); });
      openBtn.addEventListener('click', ()=> gotoId(input.value));
      input.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') gotoId(input.value);
        if(e.key === 'Escape') exitEdit();
      });
      input.addEventListener('paste', ()=> setTimeout(()=>{ input.value = extractId(input.value); },0));

      if(!('BarcodeDetector' in window)){ scanBtn.style.display='none'; }
    })();

    // ——— Escáner con cámara (QR / Code128) ———
    (function setupScanner(){
      if(!('BarcodeDetector' in window)) return;

      const overlay = document.getElementById('scanOverlay');
      const video   = document.getElementById('scanVideo');
      const status  = document.getElementById('scanStatus');
      const openBtn = document.getElementById('scanBtn');
      const closeBtn= document.getElementById('closeScanBtn');

      let stream = null;
      let running = false;
      const detector = new BarcodeDetector({ formats: ['qr_code','code_128','code_39','code_93','ean_13'] });

      async function start(){
        try{
          overlay.style.display='flex';
          status.textContent = 'Inicializando cámara…';
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
          video.srcObject = stream;
          running = true;
          tick();
        }catch(err){
          status.innerHTML = '<span class="error">No se pudo abrir la cámara</span>';
        }
      }
      function stop(){
        running = false;
        if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
        overlay.style.display='none';
      }
      async function tick(){
        if(!running) return;
        try{
          const codes = await detector.detect(video);
          if(codes && codes.length){
            const raw = (codes[0].rawValue || '').trim();
            if(raw){ stop(); gotoId(raw); return; }
          }
        }catch(_){}
        requestAnimationFrame(tick);
      }
      openBtn.addEventListener('click', start);
      closeBtn.addEventListener('click', stop);
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) stop(); });
    })();

    // ——— App ———
    async function main() {
      const id = getId();
      const statusEl = document.getElementById('status');
      const cardEl = document.getElementById('card');
      const rowsEl = document.getElementById('rows');
      const extraLinks = document.getElementById('extra-links');
      const imgWrap = document.getElementById('imgWrap');

      if (!id) { statusEl.innerHTML = '<span class="error">Falta parámetro "id"</span>'; return; }

      try {
        statusEl.textContent = 'Consultando…';
        const r = await fetch(`${FLOW_GET_BOBINA_URL}&id=${encodeURIComponent(id)}&t=${Date.now()}`, {
          cache: 'no-store',
          headers: { 'Accept': 'application/json' }
        });
        const txt = await r.text();
        let data; try { data = JSON.parse(txt); } catch { data = { error:'parse_error', raw:txt }; }
        if (!r.ok || data.error) {
          statusEl.innerHTML = `<span class="error">Error: ${data.message || data.error || r.status}</span>`;
          return;
        }

        const get = (k, alts=[]) => {
          if (data[k] != null && data[k] !== '') return data[k];
          for (const a of alts) if (data[a] != null && data[a] !== '') return data[a];
          return '';
        };

        const itemsStatic = [
          ['ID_FILA', get('ID_FILA') || get('ID')],
          ['CÓDIGO', get('CODIGO', ['CÓDIGO'])],
          ['DESCRIPCIÓN', get('DESCRIPCION', ['DESCRIPCIÓN'])],
          ['PROVEEDOR', get('PROVEEDOR')],
          ['FECHA INGRESO', get('FECHA_INGRESO', ['FECHA INGRESO']) || '—'],
          ['LOTE', get('LOTE')],
          ['FECHA DEVOLUCIÓN', get('FECHA_DEVOLUCION', ['FECHA DEVOLUCIÓN']) || '—'],
          ['LÍNEA', get('ULTIMA_LINEA', ['LINEA'])],
          ['OBSERVACIÓN', get('OBSERVACION', ['OBSERVACIÓN'])]
        ];
        rowsEl.innerHTML = itemsStatic.map(([k,v]) => `<div class="row"><b>${k}:</b> ${v || ''}</div>`).join('');

        // Editables (Netlify)
        const guardarCambio = async (payload, status, afterOk) => {
          const r = await fetch('/api/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const txt = await r.text();
          let out; try { out = JSON.parse(txt); } catch { out = { raw: txt }; }
          if (!r.ok || out.error) throw new Error(out.message || out.error || r.status);
          status.textContent = 'OK';
          await refetchAndPatch();
          afterOk();
        };
        async function refetchAndPatch() {
          const r2 = await fetch(`${FLOW_GET_BOBINA_URL}&id=${encodeURIComponent(id)}&v=${Date.now()}`, {
            cache: 'no-store',
            headers: { 'Accept': 'application/json' }
          });
          const t2 = await r2.text();
          let d2; try { d2 = JSON.parse(t2); } catch { d2 = null; }
          if (r2.ok && d2 && !d2.error) {
            document.getElementById('val-cantidad') && (document.getElementById('val-cantidad').textContent = d2.CANTIDAD ?? '');
            document.getElementById('val-ubicacion_almacen') && (document.getElementById('val-ubicacion_almacen').textContent =
              d2.UBICACION_ALMACEN || d2['UBICACION ALMACEN'] || d2['UBICACIÓN'] || '');
            document.getElementById('val-estado') && (document.getElementById('val-estado').textContent = d2.ESTADO ?? '');
          }
        }

        function editableRow({ label, value, field, type = 'text', onSave }) {
          const row = document.createElement('div');
          row.className = 'row';
          const bold = document.createElement('b'); bold.textContent = label + ':';
          const span = document.createElement('span'); span.id = `val-${field}`; span.textContent = value ?? '';

          const btn = document.createElement('button');
          btn.type = 'button'; btn.className = 'btn btn-ghost'; btn.textContent = 'Editar';

          const inputWrap = document.createElement('span'); inputWrap.style.display = 'none';
          const input = document.createElement('input');
          input.className = 'input'; input.type = (type === 'number') ? 'number' : 'text';
          if (type === 'number') { input.min = '0'; input.step = '1'; }
          input.value = value ?? '';

          const save = document.createElement('button'); save.type = 'button'; save.className = 'btn'; save.textContent = 'Guardar';
          const cancel = document.createElement('button'); cancel.type = 'button'; cancel.className = 'btn btn-ghost'; cancel.textContent = 'Cancelar';
          const status = document.createElement('span'); status.className = 'status muted'; status.style.marginLeft = '8px';

          inputWrap.appendChild(input); inputWrap.appendChild(save); inputWrap.appendChild(cancel); inputWrap.appendChild(status);
          row.appendChild(bold); row.appendChild(span); row.appendChild(btn); row.appendChild(inputWrap);

          function enterEdit(){ btn.style.display='none'; span.style.display='none'; inputWrap.style.display='inline-flex'; input.focus(); input.select(); }
          function exitEdit(){ btn.style.display='inline-block'; span.style.display='inline'; inputWrap.style.display='none'; status.textContent=''; }

          btn.addEventListener('click', enterEdit);
          cancel.addEventListener('click', exitEdit);
          save.addEventListener('click', async ()=>{
            const newValRaw = (type === 'number') ? Number(input.value) : input.value.trim();
            status.textContent = 'Guardando…';
            try{
              await onSave(newValRaw, status, (finalVal)=>{ span.textContent = (finalVal ?? newValRaw) || ''; exitEdit(); });
            }catch(e){ status.innerHTML = `<span class="error">${e?.message || 'Error'}</span>`; }
          });

          return row;
        }

        // CANTIDAD
        rowsEl.appendChild(editableRow({
          label: 'CANTIDAD',
          value: get('CANTIDAD'),
          field: 'cantidad',
          type: 'number',
          onSave: async (newVal, status, done) => {
            if (isNaN(newVal) || newVal < 0) throw new Error('Cantidad inválida');
            await guardarCambio({ id, cantidad: Number(newVal) }, status, done);
          }
        }));
        // UBICACIÓN
        rowsEl.appendChild(editableRow({
          label: 'UBICACIÓN',
          value: get('UBICACION_ALMACEN', ['UBICACIÓN']),
          field: 'ubicacion_almacen',
          type: 'text',
          onSave: async (newVal, status, done) => {
            if (!newVal) throw new Error('Ubicación vacía');
            await guardarCambio({ id, ubicacion_almacen: newVal }, status, done);
          }
        }));
        // ESTADO (texto libre)
        rowsEl.appendChild(editableRow({
          label: 'ESTADO',
          value: get('ESTADO'),
          field: 'estado',
          type: 'text',
          onSave: async (newVal, status, done) => {
            if (!newVal) throw new Error('Ingresá un estado');
            await guardarCambio({ id, estado: newVal }, status, done);
          }
        }));

        // Link ficha/imagen
        const url = get('URL');
        if (url) {
          extraLinks.innerHTML = fieldRow('Ficha/Imagen', `<a href="${url}" target="_blank" rel="noreferrer">Abrir</a>`);
        }

        cardEl.style.display = 'block';
        statusEl.style.display = 'none';

        // Imagen
        const raw = get('IMAGEN_URL', ['IMAGEN URL']);
        if (raw) {
          const imgUrl = normalizeSharePointImageUrl(raw);
          imgWrap.innerHTML = `
            <img src="${imgUrl}" alt="Etiqueta" class="hero-img" loading="lazy" referrerpolicy="no-referrer" />
            <div style="margin-top:6px">
              <a href="${imgUrl}" target="_blank" rel="noreferrer">Abrir en pestaña nueva</a>
            </div>`;
        } else {
          imgWrap.innerHTML = '<span class="muted">Sin imagen configurada.</span>';
        }

        // Devolución
        const dev = document.getElementById('devolucion');
        const devForm = document.getElementById('devForm');
        const devStatus = document.getElementById('devStatus');
        dev.style.display = 'block';
        devForm.addEventListener('submit', async (ev) => {
          ev.preventDefault();
          devStatus.textContent = 'Enviando…';
          const payload = {
            id,
            cantidad_devolucion: Number(devForm.cantidad_devolucion.value),
            linea: devForm.linea.value || undefined,
            observacion: devForm.observacion.value || undefined,
            usuario: devForm.usuario.value || undefined
          };
          Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);

          try {
            const rr = await fetch('/api/devolucion', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const t2 = await rr.text();
            let out; try { out = JSON.parse(t2); } catch { out = { raw: t2 }; }
            if (!rr.ok || out.error) {
              devStatus.innerHTML = `<span class="error">Error: ${out.message || out.error || rr.status}</span>`;
              return;
            }
            devStatus.textContent = 'OK. Devolución cargada.';
            setTimeout(() => window.location.reload(), 800);
          } catch (e) {
            devStatus.innerHTML = `<span class="error">${e?.message || 'Error inesperado'}</span>`;
          }
        });

      } catch (e) {
        const statusEl = document.getElementById('status');
        statusEl.innerHTML = `<span class="error">${e?.message || 'Error inesperado'}</span>`;
      }
    }

    main();
  </script>
</body>
</html>



























